# RideTheBus V2 — Claude Reference

## Stack
- React 18.3 + TypeScript + Vite 7 (**requires Node 20.19+ or 22.12+** — use `nvm use 22`)
- Tailwind CSS v4 (`@tailwindcss/vite` plugin — no `tailwind.config.js`)
- TanStack Start v1 (SSR, file-based routing via TanStack Router v1)
- TanStack Query v5 (data fetching / caching layer)
- Supabase, Radix UI, Recharts

## Project structure
```
src/
  routes/            # TanStack Router file-based routes
    __root.tsx        # root layout (providers + head meta + Header/Footer)
    index.tsx         # /
    beerdle.tsx       # /beerdle
    stats.tsx         # /stats
    login.tsx         # /login
    sign-up.tsx       # /sign-up
    $username.profile.tsx  # /:username/profile
    party-bus.tsx     # /party-bus (layout with Outlet)
    party-bus.index.tsx    # /party-bus/
    party-bus.$roomCode.tsx # /party-bus/:roomCode
    $.tsx             # catch-all → redirect to /
  routeTree.gen.ts   # auto-generated by TanStack Router (gitignored)
  router.tsx         # exports getRouter() — discovered by TanStack Start plugin
  entry.client.tsx   # client hydration entry
  entry.server.tsx   # SSR request handler
  components/        # reusable components
    ui/              # brand primitives (Button, Panel)
  pages/             # page components (imported by route files)
  contexts/          # AuthContext
  api/               # Supabase API helpers
  lib/               # shared singletons: queryClient.ts, queryKeys.ts
  utils/             # utility functions
  types/             # TypeScript types
  index.css          # global styles + @theme token definitions
```

## Commands
```bash
npm run dev          # dev server → http://localhost:5173
npx tsc --noEmit     # type-check (run before every commit)
npm run lint         # ESLint check (also runs in CI)
npm run start        # start production SSR server (node dist/server.js)
```

## Linting gotchas
- CI runs ESLint via `npm run lint` — must be clean before merging
- `react/no-unescaped-entities`: apostrophes and quotes in JSX text must be escaped
  - `'` → `&apos;`  |  `"` → `&quot;`
  - Applies to all text content inside JSX tags (not inside `{}` expressions or attributes)

## Routing conventions (TanStack Router)
- `Link`, `useNavigate`, `useParams` all import from `@tanstack/react-router`
- `navigate({ to: '/path' })` — object form, not string
- `navigate({ to: '/party-bus/$roomCode', params: { roomCode } })` — with params
- `useParams({ strict: false })` — when called outside the defining route file
- `src/routeTree.gen.ts` is auto-generated on `npm run dev`; never edit manually
- Head meta (title, OG tags) lives in each route's `head()` function, not in components

## Tailwind v4 custom tokens
Tokens live in the `@theme {}` block in `src/index.css` — not in a config file.
Each `--color-*` variable auto-generates utility classes:
```css
--color-brand: #dc2626;        →  bg-brand, text-brand, border-brand
--color-surface-raised: #1a2531; →  bg-surface-raised, etc.
```

Current brand tokens:
| Token | Value | Utility |
|---|---|---|
| `--color-surface` | `#22303f` | `bg-surface` |
| `--color-surface-raised` | `#1a2531` | `bg-surface-raised` |
| `--color-surface-input` | `#374151` | `bg-surface-input` |
| `--color-brand` | `#dc2626` | `bg-brand` |
| `--color-brand-hover` | `#b91c1c` | `bg-brand-hover` |

## UI primitives (`src/components/ui/`)

### Button
Variants: `primary` (brand red), `secondary` (amber), `ghost` (white), `dark` (black)
```tsx
<Button variant="primary">Create Room</Button>
<Button variant="secondary">Sign In</Button>
<Button variant="ghost">Redraw Cards</Button>
```

### Panel
Dark surface container (`bg-surface-raised` + border + shadow). Accepts `className` for extension.
```tsx
<Panel className="max-w-md">...</Panel>
```

### When to use primitives vs. raw Tailwind
**Use a primitive when:**
- The same pattern appears in 3+ places
- The styling carries brand/semantic meaning (CTAs, surface containers)

**Keep raw Tailwind when:**
- Styling is semantically tied to game state or content (e.g. red suit = red button)
- It's a one-off layout, spacing, or typography situation
- A component would need so many props it's harder to read than raw classes

### The game-mechanics exception
Buttons in `Game.tsx` tied to game state (Red/Black, Higher/Lower/Same, Inside/Outside, suits)
intentionally do **not** use the Button component. Their colors reflect game rules, not brand
theme, and should stay independent.

## Git & PR workflow
1. `npx tsc --noEmit` — must be clean
2. Stage specific files by name (never `git add -A`)
3. Commit message: imperative title + blank line + body explaining *why*
4. Push branch → `gh pr create --draft` with a test plan checklist in the body

## TanStack Query conventions
- `QueryClient` singleton lives in `src/lib/queryClient.ts` (staleTime 5 min, retry 1)
- All query keys live in `src/lib/queryKeys.ts` — always use these for queries **and** invalidations
- `dailySeed` query uses `staleTime: Infinity` (seed never changes mid-day)
- **Intentionally NOT using TanStack Query:** `AuthContext` (realtime auth subscription), `PartyBus` (realtime
  Supabase channel), `Login`/`SignUp` (fire-and-forget mutations, no caching value)
- No devtools installed

## Claude-specific notes
- **Worktrees do not inherit `.env`** — if you see `supabaseUrl is required`, copy it over:
  ```bash
  cp /Users/marcinlukanus/Projects/RideTheBusV2/.env .
  ```
